# Don't double-build PR commits. See: http://stackoverflow.com/a/31882307/1877326
branches:
  only: 
    - master
dist: xenial
sudo: required
language: python
services:
    - postgresql
addons:
  postgresql: "9.5"
  chrome: stable
  apt:
    packages:
      - build-essential
      - fontforge
      - gettext
      - git-core
      - libpcre3
      - libpcre3-dev
      - libpq-dev
      # for cypress
      - xvfb
      - libgtk2.0-0 
      - libnotify-dev 
      - libgconf-2-4 
      - libnss3 
      - libxss1 
      - libasound2
cache:
  directories:
    - $HOME/.pip-download-cache
    # keep the npm cache around to speed up installs
    - $HOME/.npm
    - $HOME/.cache
before_script:
  - psql -c 'create database travis_ci_test;' -U postgres
  # for Cypress
  - ./manage.py runserver &
script:
  - npm run copy-fonts
  - npm run build
  - pytest -vv --cov
  - npm run test
after_script:
  - coverage xml && python-codacy-coverage -r coverage.xml
  - coveralls
env:
  # All about YAML line breaks: https://stackoverflow.com/a/21699210
  - >-
       PIP_DOWNLOAD_CACHE=$HOME/.pip-download-cache
       DJANGO_DEBUG=False
       DJANGO_SECRET_KEY=ZGtvYm90cmF2aXM
       DJANGO_SETTINGS_MODULE=kobo.settings
       DATABASE_URL="postgres://postgres@localhost:5432/travis_ci_test"
       TRAVIS_NODE_VERSION="8"
       PATH=$PATH:$HOME/build/kobotoolbox/kpi/node_modules/.bin/
       CYPRESS_baseUrl=http://127.0.0.1:8000/
install:
  -  >-
        rm -rf ~/.nvm &&
        git clone https://github.com/creationix/nvm.git ~/.nvm &&
        (cd ~/.nvm &&
        git checkout `git describe --abbrev=0 --tags`) &&
        source ~/.nvm/nvm.sh &&
        nvm install $TRAVIS_NODE_VERSION
  - npm install -g install npm@latest
  - npm config set strict-ssl false && npm ci
  - pip install --upgrade 'pip>=8.0' wheel
  - pip install pip-tools
  - pip-sync dependencies/pip/requirements.txt
  - pip install coverage codacy-coverage python-coveralls pytest-cov
